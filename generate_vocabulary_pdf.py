#!/usr/bin/env python3
"""
ç”Ÿæˆä¸“ä¸šè¯æ±‡è¡¨PDFæ–‡ä»¶
"""

from reportlab.lib.pagesizes import letter, A4
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib.units import inch
from reportlab.lib.colors import black, blue, red, green, white
from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle
from reportlab.lib.enums import TA_LEFT, TA_CENTER, TA_JUSTIFY
from vocabulary_extractor.pdf.processor import PDFProcessor
from vocabulary_extractor.dictionary.service import LocalDictionaryService
import re
import os

def create_professional_vocabulary_pdf(input_pdf="sample.pdf", output_pdf="vocabulary_list.pdf"):
    """åˆ›å»ºä¸“ä¸šçš„è¯æ±‡è¡¨PDF"""
    
    if not os.path.exists(input_pdf):
        print(f"âŒ è¾“å…¥æ–‡ä»¶ {input_pdf} ä¸å­˜åœ¨")
        return
    
    # åˆå§‹åŒ–ç»„ä»¶
    processor = PDFProcessor()
    dict_service = LocalDictionaryService()
    
    # æå–æ–‡æœ¬å’Œè¯æ±‡
    text = processor.extract_text(input_pdf)
    
    # æå–å’Œæ ‡å‡†åŒ–è¯æ±‡
    word_pattern = re.compile(r'\b[A-Za-z]{2,}\b')
    words = word_pattern.findall(text.lower())
    
    # åœç”¨è¯
    stop_words = {
        'the', 'and', 'is', 'in', 'for', 'of', 'to', 'a', 'this', 'that', 
        'with', 'are', 'as', 'at', 'be', 'by', 'from', 'has', 'he', 'it', 
        'its', 'on', 'was', 'were', 'will', 'all', 'over', 'contains', 
        'used', 'an', 'or', 'but', 'not', 'have', 'had', 'do', 'does'
    }
    
    unique_words = sorted(set(words) - stop_words)
    
    # åˆ›å»ºPDFæ–‡æ¡£
    doc = SimpleDocTemplate(
        output_pdf,
        pagesize=A4,
        rightMargin=72,
        leftMargin=72,
        topMargin=72,
        bottomMargin=18
    )
    
    # æ ·å¼å®šä¹‰
    styles = getSampleStyleSheet()
    
    title_style = ParagraphStyle(
        'CustomTitle',
        parent=styles['Heading1'],
        fontSize=24,
        spaceAfter=30,
        alignment=TA_CENTER,
        textColor=blue
    )
    
    subtitle_style = ParagraphStyle(
        'CustomSubtitle',
        parent=styles['Normal'],
        fontSize=14,
        spaceAfter=20,
        alignment=TA_CENTER,
        textColor=black
    )
    
    word_style = ParagraphStyle(
        'WordStyle',
        parent=styles['Normal'],
        fontSize=12,
        spaceAfter=12,
        textColor=black
    )
    
    # æ„å»ºå†…å®¹
    story = []
    
    # æ ‡é¢˜
    story.append(Paragraph("ğŸ“š Vocabulary List", title_style))
    story.append(Paragraph(f"Extracted from: {input_pdf}", subtitle_style))
    story.append(Paragraph(f"Total Vocabulary: {len(unique_words)} words", subtitle_style))
    story.append(Spacer(1, 20))
    
    # åˆ›å»ºè¡¨æ ¼æ•°æ®
    table_data = [['Word', 'Pronunciation', 'Definition']]
    
    for word in unique_words[:30]:  # é™åˆ¶å‰30ä¸ª
        definition = dict_service.get_definition(word)
        pronunciation = dict_service.get_pronunciation(word)
        
        # é™åˆ¶å®šä¹‰é•¿åº¦
        if len(definition) > 50:
            definition = definition[:47] + "..."
        
        table_data.append([
            f"<b>{word}</b>",
            f"<i>{pronunciation}</i>",
            definition
        ])
    
    # åˆ›å»ºè¡¨æ ¼
    table = Table(table_data, colWidths=[1.5*inch, 1.5*inch, 3.5*inch])
    
    # è¡¨æ ¼æ ·å¼
    table.setStyle(TableStyle([
        ('BACKGROUND', (0, 0), (-1, 0), blue),
        ('TEXTCOLOR', (0, 0), (-1, 0), white),
        ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
        ('FONTSIZE', (0, 0), (-1, 0), 12),
        ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
        ('BACKGROUND', (0, 1), (-1, -1), white),
        ('TEXTCOLOR', (0, 1), (-1, -1), black),
        ('FONTNAME', (0, 1), (-1, -1), 'Helvetica'),
        ('FONTSIZE', (0, 1), (-1, -1), 10),
        ('GRID', (0, 0), (-1, -1), 1, black),
        ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
        ('ROWBACKGROUNDS', (0, 1), (-1, -1), [white, (0.9, 0.9, 0.9)])
    ]))
    
    story.append(table)
    
    # æ·»åŠ é¡µè„š
    story.append(Spacer(1, 30))
    story.append(Paragraph("Generated by PDF Vocabulary Extractor", 
                          ParagraphStyle('Footer', alignment=TA_CENTER, textColor=red, fontSize=8)))
    
    # æ„å»ºPDF
    doc.build(story)
    print(f"âœ… ä¸“ä¸šè¯æ±‡è¡¨å·²åˆ›å»º: {output_pdf}")
    print(f"ğŸ“Š åŒ…å« {min(30, len(unique_words))} ä¸ªè¯æ±‡")
    
    return output_pdf

if __name__ == "__main__":
    # åˆ›å»ºå¤šä¸ªè¾“å‡ºæ–‡ä»¶
    create_professional_vocabulary_pdf("sample.pdf", "vocabulary_list.pdf")
    
    # å¦‚æœæœ‰test_input.pdfä¹Ÿå¤„ç†
    if os.path.exists("test_input.pdf"):
        create_professional_vocabulary_pdf("test_input.pdf", "vocabulary_list_test.pdf")
    
    print("\nğŸ“ ç”Ÿæˆçš„æ–‡ä»¶:")
    print("- vocabulary_list.pdf (æ¥è‡ªsample.pdf)")
    if os.path.exists("test_input.pdf"):
        print("- vocabulary_list_test.pdf (æ¥è‡ªtest_input.pdf)")